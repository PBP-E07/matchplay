{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-2xl">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Create New Match Room</h1>

    <!-- Display Messages -->
    {% if messages %}
        <div class="mb-6 space-y-2">
            {% for message in messages %}
                <div class="p-4 rounded-md text-sm
                    {% if message.tags == 'success' %} bg-green-100 text-green-800 border border-green-200
                    {% elif message.tags == 'error' %} bg-red-100 text-red-800 border border-red-200
                    {% else %} bg-blue-100 text-blue-800 border border-blue-200 {% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" action="{% url 'matches:create_match' %}" class="bg-white p-6 rounded-lg shadow-md space-y-4">
        {% csrf_token %}

        {# Display non-field errors first (like venue conflict) #}
        {% if form.non_field_errors %}
            <div class="p-3 rounded-md text-sm bg-red-50 text-red-700 border border-red-200">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        {# --- Field: 'field' --- #}
        <div>
            <label for="{{ form.field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                {{ form.field.label }}
            </label>
            {{ form.field }} {# Renders the widget with id='id_field' from form #}
            {% if form.field.errors %}<div class="mt-1 text-xs text-red-600 space-y-0.5">{% for error in form.field.errors %}<p>{{ error }}</p>{% endfor %}</div>{% endif %}
        </div>
        
        {# --- Field: 'match_date' --- #}
        <div>
            <label for="{{ form.match_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                {{ form.match_date.label }}
            </label>
            {{ form.match_date }} {# Renders the widget with id='id_match_date' from form #}
            {% if form.match_date.errors %}<div class="mt-1 text-xs text-red-600 space-y-0.5">{% for error in form.match_date.errors %}<p>{{ error }}</p>{% endfor %}</div>{% endif %}
        </div>

        {# --- NEW: time_slot --- #}
        <div class="mb-6">
            <p class="block text-sm font-medium text-gray-700 mb-3">{{ form.time_slot.label }}</p>
            <div id="time-slot-options" class="grid grid-cols-2 gap-4">
                <!-- Time slots loaded via JavaScript -->
                 <p id="loading-slots" class="text-gray-500 text-sm col-span-2">Select a field and date to see available times.</p>
                 <p id="no-slots-message" class="text-gray-500 text-sm col-span-2 hidden">No available slots.</p>
                 
                 {# Render errors for time_slot #}
                 {% if form.time_slot.errors %}
                    <div class="mt-1 text-xs text-red-600 space-y-0.5 col-span-2">
                        {% for error in form.time_slot.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                 {% endif %}
            </div>
        </div>

        {# --- Loop for remaining fields --- #}
        {% for field in form %}
            {# Only render fields that are NOT the ones we manually placed #}
            {% if field.name not in "field,match_date,time_slot" %}
            <div>
                <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ field.label }}
                </label>
                {{ field }} {# Renders the widget #}
                {% if field.help_text %}
                    <p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>
                {% endif %}
                {% if field.errors %}
                    <div class="mt-1 text-xs text-red-600 space-y-0.5">
                        {% for error in field.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            {% endif %}
        {% endfor %}

        <div class="pt-4 flex justify-end">
            <button type="submit" class="px-6 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition duration-150">
                Create Match
            </button>
             <a href="{% url 'matches:match_list' %}" class="ml-3 px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Cancel
            </a>
        </div>
    </form>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get elements by ID specified in the form
    const fieldSelect = document.getElementById('id_field');
    const dateInput = document.getElementById('id_match_date');
    const timeSlotContainer = document.getElementById('time-slot-options');
    const loadingMessage = document.getElementById('loading-slots');
    const noSlotsMessage = document.getElementById('no-slots-message');

    function fetchAndDisplaySlots() {
        const selectedFieldId = fieldSelect.value;
        const selectedDate = dateInput.value;

        // Don't fetch if either is empty
        if (!selectedFieldId || !selectedDate) {
            timeSlotContainer.innerHTML = ''; // Clear previous
            loadingMessage.textContent = 'Select a field and date to see available times.';
            loadingMessage.style.display = 'block';
            noSlotsMessage.style.display = 'none';
            timeSlotContainer.appendChild(loadingMessage);
            return;
        }

        loadingMessage.style.display = 'block';
        noSlotsMessage.style.display = 'none';
        timeSlotContainer.innerHTML = ''; // Clear previous slots
        timeSlotContainer.appendChild(loadingMessage); // Show loading

        const url = `/matches/get_match_slots/?field_id=${selectedFieldId}&date=${selectedDate}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                loadingMessage.style.display = 'none';
                timeSlotContainer.innerHTML = ''; // Clear loading message

                if (data.error) {
                    console.error('Error fetching slots:', data.error);
                    noSlotsMessage.textContent = `Error: ${data.error}`;
                    noSlotsMessage.style.display = 'block';
                    timeSlotContainer.appendChild(noSlotsMessage);
                
                } else if (data.slots && data.slots.length > 0) {
                    
                    let hasAvailableSlots = false;

                    data.slots.forEach((slot, index) => {
                        const slotValue = `${slot.start}-${slot.end}`;
                        const inputId = `id_time_slot_${index}`; // Use index for unique ID

                        const label = document.createElement('label');
                        label.htmlFor = inputId;
                        
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = '{{ form.time_slot.name }}';
                        input.value = slotValue;
                        input.id = inputId;
                        input.className = 'mr-2 h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500';

                        let labelText = `${slot.start} - ${slot.end}`;
                        
                        if (slot.status === 'available') {
                            hasAvailableSlots = true;
                            // Classes for available slots
                            label.className = 'flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer text-gray-700';
                        } else {
                            input.disabled = true;
                            if (slot.status === 'booked') {
                                labelText += ' (Booked)';
                            } else if (slot.status === 'match_created') {
                                labelText += ' (Match Created)';
                            }
                            // Add classes for disabled/greyed-out look
                            label.className = 'flex items-center p-3 border rounded-lg bg-gray-100 text-gray-400 line-through cursor-not-allowed';
                        }
                        
                        label.appendChild(input);
                        label.appendChild(document.createTextNode(labelText));
                        timeSlotContainer.appendChild(label);
                    });

                    if (!hasAvailableSlots) {
                        noSlotsMessage.textContent = 'All slots are unavailable for this field and date.';
                        noSlotsMessage.style.display = 'block';
                        timeSlotContainer.appendChild(noSlotsMessage);
                    } else {
                        noSlotsMessage.style.display = 'none';
                    }

                } else {
                     // This might happen if date is in the past
                     noSlotsMessage.textContent = data.message || 'No slots available for this date.';
                     noSlotsMessage.style.display = 'block';
                     timeSlotContainer.appendChild(noSlotsMessage);
                }
            })
            .catch(error => {
                loadingMessage.style.display = 'none';
                timeSlotContainer.innerHTML = '';
                noSlotsMessage.textContent = 'Error loading time slots. Please try again.';
                noSlotsMessage.style.display = 'block';
                timeSlotContainer.appendChild(noSlotsMessage);
                console.error('Fetch error:', error);
            });
    }

    // --- Initial Load ---
    // Trigger only if both field and date have values on page load
    if (fieldSelect.value && dateInput.value) {
        fetchAndDisplaySlots();
    }

    // --- Event Listeners ---
    // Fetch new slots when *either* the field or the date changes
    fieldSelect.addEventListener('change', fetchAndDisplaySlots);
    dateInput.addEventListener('change', fetchAndDisplaySlots);
});
</script>
{% endblock %}

