{% extends 'base.html' %}
{% block title %}Pertandingan — {{ tournament.name }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-6 py-10">

  <!-- Back Button -->
  <a href="/tournament/{{ tournament.id }}/"
     class="flex items-center text-gray-600 hover:text-green-600 mb-6">
    ← <span class="ml-2">Kembali ke Turnamen</span>
  </a>

  <!-- Title -->
  <h1 class="text-3xl font-bold text-center mb-2">{{ tournament.name }}</h1>

  <!-- Tabs -->
  <div class="flex justify-center border-b mb-6">
    <button class="tab text-green-600 border-b-2 border-green-600 font-semibold px-4 pb-2"
            data-filter="">Semua</button>
    <button class="tab text-gray-400 hover:text-green-600 px-4 pb-2"
            data-filter="remaining">Tersisa</button>
    <button class="tab text-gray-400 hover:text-green-600 px-4 pb-2"
            data-filter="finished">Selesai</button>
  </div>

  <!-- Matches container -->
  <div id="matches" class="space-y-5"></div>

  <!-- Add Match button -->
  <div class="mt-10 flex justify-center">
    <a href="{% url 'tournament:create_match' tournament.id %}"
       class="bg-green-500 hover:bg-green-600 text-white font-semibold text-lg px-8 py-3 rounded-lg shadow-md transition">
       Tambahkan Match
    </a>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
  const tabs = document.querySelectorAll('.tab');

  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x => x.classList.remove('text-green-600','border-b-2','border-green-600'));
    tabs.forEach(x => x.classList.add('text-gray-400'));
    t.classList.add('text-green-600','border-b-2','border-green-600');

    const f = t.dataset.filter || '';
    loadMatches(f);
  }));

  async function loadMatches(filter = '') {
    try {
      const res = await fetch(`/tournament/api/{{ tournament.id }}/matches/?_=${Date.now()}`, {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      });
      const el = document.getElementById('matches');

      if (!res.ok) {
        el.innerHTML = `<div class="bg-red-100 border border-red-300 text-red-700 p-4 rounded">
          Gagal memuat data pertandingan (status ${res.status}).
        </div>`;
        return;
      }

      const data = await res.json();
      console.log("Data match:", data); 

      let rows = data;
      if (filter === 'remaining') rows = data.filter(m => m.winner_name === null);
      else if (filter === 'finished') rows = data.filter(m => m.winner_name !== null);

      if (!rows.length) {
        el.innerHTML = `<div class="p-6 text-center text-gray-500 border rounded-xl">Belum ada pertandingan</div>`;
        return;
      }

      el.innerHTML = rows.map(m => {
        const s1 = m.score_team1 ?? '-';
        const s2 = m.score_team2 ?? '-';
        const winnerLine = m.winner_name
          ? `<p class="text-green-600 font-medium text-sm">Pemenang: ${m.winner_name}</p>`
          : `<p class="text-gray-400 text-sm">Belum selesai</p>`;

        const logo1 = m.team1_logo || "https://via.placeholder.com/40?text=T1";
        const logo2 = m.team2_logo || "https://via.placeholder.com/40?text=T2";

        return `
          <div class="bg-white border border-green-300 rounded-xl shadow-sm hover:shadow-md transition p-5">
            <p class="text-sm text-gray-500 font-semibold mb-2">Round ${m.round_number || '-'}</p>

            <div class="flex justify-between items-center mb-2">
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-2">
                  <img src="${logo1}" class="w-8 h-8 rounded-full object-cover border" alt="${m.team1_name}">
                  <p class="font-semibold text-gray-700">${m.team1_name}</p>
                </div>
                <div class="flex items-center gap-2">
                  <img src="${logo2}" class="w-8 h-8 rounded-full object-cover border" alt="${m.team2_name}">
                  <p class="font-semibold text-gray-700">${m.team2_name}</p>
                </div>
              </div>

              <div class="text-right">
                <p class="text-xl font-bold text-gray-800">${s1} - ${s2}</p>
                ${winnerLine}
              </div>
            </div>

            <div class="flex justify-end gap-4 border-t pt-2 mt-3 text-sm">
              <a href="/tournament/${m.tournament_id}/matches/${m.id}/edit/"
                class="text-blue-600 hover:text-blue-800">Edit</a>
              <a href="/tournament/${m.tournament_id}/matches/${m.id}/delete/"
                class="text-red-600 hover:text-red-800">Hapus</a>
            </div>
          </div>`;
      }).join('');

    } catch (err) {
      console.error("Error loading matches:", err);
      document.getElementById('matches').innerHTML = `
        <div class="bg-red-50 border border-red-300 text-red-700 p-4 rounded">
          Terjadi kesalahan saat memuat pertandingan.
        </div>`;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM loaded, fetching matches...");
    loadMatches();
  });
</script>
{% endblock %}

