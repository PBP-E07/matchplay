{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-2xl">
    <h1 class="text-3xl font-bold mb-4 text-gray-800">Book {{ field.name }}</h1>
    <p class="text-gray-600 mb-6">{{ field.location }} | {{ field.get_sport_display }}</p>

    {% if messages %}
        <div class="mb-6 space-y-2">
            {% for message in messages %}
                <div class="p-4 rounded-md text-sm {% if message.tags == 'success' %} bg-green-100 text-green-800 border border-green-200 {% elif message.tags == 'error' %} bg-red-100 text-red-800 border border-red-200 {% else %} bg-blue-100 text-blue-800 border border-blue-200 {% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" id="booking-form" action="{% url 'bookings:book_field' field.id %}">
        {% csrf_token %}

        <div class="mb-6 bg-white p-6 rounded-lg shadow-md">
            <label for="{{ form.booking_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.booking_date.label }}</label>
            {{ form.booking_date }}
             {% if form.booking_date.errors %}
                <p class="text-red-600 text-xs mt-1">{{ form.booking_date.errors|join:", " }}</p>
            {% endif %}
        </div>

        <div class="mb-6 bg-white p-6 rounded-lg shadow-md">
            <p class="block text-sm font-medium text-gray-700 mb-3">{{ form.time_slot.label }}</p>
            <div id="time-slot-options" class="grid grid-cols-2 gap-4"> <p id="loading-slots" class="text-gray-500 text-sm col-span-2">Select a date to see available times.</p>
                 <p id="no-slots-message" class="text-gray-500 text-sm col-span-2 hidden">No available slots for the selected date.</p>
                 
                 {% if form.time_slot.errors %}
                    <p class="text-red-600 text-xs mt-2 col-span-2">{{ form.time_slot.errors|join:", " }}</p>
                 {% endif %}
                 {% if form.non_field_errors %}
                     <p class="text-red-600 text-xs mt-2 col-span-2">{{ form.non_field_errors|join:", " }}</p>
                 {% endif %}
            </div>
        </div>

        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300">
            Book Now
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('{{ form.booking_date.id_for_label }}');
    const timeSlotContainer = document.getElementById('time-slot-options');
    const loadingMessage = document.getElementById('loading-slots');
    const noSlotsMessage = document.getElementById('no-slots-message');
    const fieldId = '{{ field.id }}';

    function fetchAndDisplaySlots(selectedDate) {
        timeSlotContainer.innerHTML = '';
        loadingMessage.style.display = 'block';
        noSlotsMessage.style.display = 'none';
        timeSlotContainer.appendChild(loadingMessage);

        const url = `/bookings/get_slots/${fieldId}/?date=${selectedDate}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                loadingMessage.style.display = 'none';
                timeSlotContainer.innerHTML = ''; // Clear loading message

                if (data.error) {
                    console.error('Error fetching slots:', data.error);
                    noSlotsMessage.textContent = `Error: ${data.error}`;
                    noSlotsMessage.style.display = 'block';
                    timeSlotContainer.appendChild(noSlotsMessage);
                
                } else if (data.slots && data.slots.length > 0) {
                    
                    // Check if all slots are booked
                    const allSlotsBooked = data.slots.every(slot => slot.is_booked);

                    data.slots.forEach((slot, index) => {
                        const slotValue = `${slot.start}-${slot.end}`;
                        const inputId = `id_time_slot_${index}`;

                        const label = document.createElement('label');
                        label.htmlFor = inputId;
                        
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = '{{ form.time_slot.name }}';
                        input.value = slotValue;
                        input.id = inputId;
                        input.className = 'mr-2 h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500';

                        label.appendChild(input);
                        label.appendChild(document.createTextNode(`${slot.start} - ${slot.end}`));

                        if (slot.is_booked) {
                            input.disabled = true;
                            // Add classes for disabled/greyed-out look
                            label.className = 'flex items-center p-3 border rounded-lg bg-gray-100 text-gray-400 line-through cursor-not-allowed';
                        } else {
                            // Classes for available slots
                            label.className = 'flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer text-gray-700';
                        }
                        
                        timeSlotContainer.appendChild(label);
                    });

                    if (allSlotsBooked) {
                        noSlotsMessage.textContent = 'All slots are fully booked for this date.';
                        noSlotsMessage.style.display = 'block';
                        timeSlotContainer.appendChild(noSlotsMessage);
                    } else {
                        noSlotsMessage.style.display = 'none';
                    }

                } else {
                     // This case should ideally not be hit if we always return all slots
                     noSlotsMessage.textContent = data.message || 'No slots available for this date.';
                     noSlotsMessage.style.display = 'block';
                     timeSlotContainer.appendChild(noSlotsMessage);
                }
            })
            .catch(error => {
                loadingMessage.style.display = 'none';
                timeSlotContainer.innerHTML = '';
                noSlotsMessage.textContent = 'Error loading time slots. Please try again.';
                noSlotsMessage.style.display = 'block';
                timeSlotContainer.appendChild(noSlotsMessage);
                console.error('Fetch error:', error);
            });
    }

    // --- Initial Load ---
    if (dateInput.value) {
        fetchAndDisplaySlots(dateInput.value);
    } else {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        fetchAndDisplaySlots(today);
    }

    // --- Event Listener for Date Change ---
    dateInput.addEventListener('change', function() {
        if (this.value) {
            fetchAndDisplaySlots(this.value);
        } else {
            timeSlotContainer.innerHTML = '';
            loadingMessage.textContent = 'Select a date to see available times.';
            loadingMessage.style.display = 'block';
            noSlotsMessage.style.display = 'none';
            timeSlotContainer.appendChild(loadingMessage);
        }
    });
});
</script>
{% endblock %}