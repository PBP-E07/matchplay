{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-2xl">
    <h1 class="text-3xl font-bold mb-4 text-gray-800">Book {{ field.name }}</h1>
    <p class="text-gray-600 mb-1"><i class="fas fa-map-marker-alt text-gray-500 mr-1"></i> {{ field.location }}</p>
    <p class="text-gray-600 mb-6"><i class="fas fa-futbol text-gray-500 mr-1"></i> {{ field.get_sport_display }} - Starting from <span class="font-semibold">Rp {{ field.price|floatformat:0 }}</span>/slot</p>

    {% if messages %}
        <div class="mb-6 space-y-2">
            {% for message in messages %}
                <div class="p-4 rounded-md text-sm
                    {% if message.tags == 'success' %} bg-green-100 text-green-800 border border-green-200
                    {% elif message.tags == 'error' %} bg-red-100 text-red-800 border border-red-200
                    {% elif message.tags == 'warning' %} bg-yellow-100 text-yellow-800 border border-yellow-200
                    {% else %} bg-blue-100 text-blue-800 border border-blue-200 {% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" id="booking-form" action="{% url 'bookings:book_field' field.id %}">
        {% csrf_token %}

        <div class="mb-6 bg-white p-6 rounded-lg shadow-md">
            <label for="{{ form.booking_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.booking_date.label }}</label>
            {{ form.booking_date }}
             {% if form.booking_date.errors %}
                {% for error in form.booking_date.errors %}
                <p class="text-red-600 text-xs mt-1">{{ error }}</p>
                {% endfor %}
            {% endif %}
        </div>

        <div class="mb-6 bg-white p-6 rounded-lg shadow-md">
            <p class="block text-sm font-medium text-gray-700 mb-3">{{ form.time_slot.label }}</p>
            <div id="time-slot-options" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <p id="loading-slots" class="text-gray-500 text-sm col-span-full">Select a date to see available times.</p>
                <p id="slots-message" class="text-gray-500 text-sm col-span-full hidden"></p>

                {% if form.time_slot.errors %}
                     {% for error in form.time_slot.errors %}
                     <p class="text-red-600 text-xs mt-2 col-span-full">{{ error }}</p>
                     {% endfor %}
                {% endif %}
                 {% if form.non_field_errors %}
                     {% for error in form.non_field_errors %}
                     <p class="text-red-600 text-xs mt-2 col-span-full">{{ error }}</p>
                     {% endfor %}
                {% endif %}
            </div>
        </div>

        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" id="submit-button" disabled>
            Book Now (Rp {{ field.price|floatformat:0 }})
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('id_booking_date');
    const timeSlotContainer = document.getElementById('time-slot-options');
    const loadingMessage = document.getElementById('loading-slots');
    const slotsMessage = document.getElementById('slots-message');
    const submitButton = document.getElementById('submit-button');
    const fieldId = '{{ field.id }}';
    // --- Get the NAME attribute of the time_slot field from the form ---
    // Find the input element rendered by Django (even if hidden or choices are empty)
    const hiddenTimeSlotInput = document.querySelector('input[name="time_slot"]');
    // Use its name attribute, or default to 'time_slot' if somehow not found
    const timeSlotName = hiddenTimeSlotInput ? hiddenTimeSlotInput.name : 'time_slot';

    let hasAvailableSlots = false;

    async function fetchAndDisplaySlots(selectedDate) {
        timeSlotContainer.innerHTML = '';
        loadingMessage.style.display = 'block';
        slotsMessage.style.display = 'none';
        submitButton.disabled = true;
        hasAvailableSlots = false;
        timeSlotContainer.appendChild(loadingMessage);

        if (!selectedDate) {
            loadingMessage.textContent = 'Please select a valid date.';
            return;
        }

        const url = `/bookings/get_slots/${fieldId}/?date=${selectedDate}`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            loadingMessage.style.display = 'none';

            if (!response.ok) {
                 throw new Error(data.error || `HTTP error! Status: ${response.status}`);
            }

            if (data.slots && data.slots.length > 0) {
                data.slots.forEach((slot, index) => {
                    const slotValue = `${slot.start}-${slot.end}`;
                    // --- Use the dynamically obtained timeSlotName ---
                    const inputId = `id_${timeSlotName}_${index}`;

                    const label = document.createElement('label');
                    label.htmlFor = inputId;

                    const input = document.createElement('input');
                    input.type = 'radio';
                    // --- Use the dynamically obtained timeSlotName ---
                    input.name = timeSlotName;
                    input.value = slotValue;
                    input.id = inputId;
                    input.required = true;
                    input.className = 'sr-only peer'; // Keep hiding the actual radio

                    let labelText = `${slot.start}`; // Display start time only
                    let labelClasses = 'block w-full text-center px-4 py-3 border rounded-lg text-sm font-medium cursor-pointer transition-colors duration-200 ';

                    if (slot.status === 'available') {
                        hasAvailableSlots = true;
                        // --- Correct Tailwind classes for selection ---
                        // Base: gray border, gray text, white bg, hover gray bg
                        // Checked: green bg, white text, green border
                        labelClasses += 'border-gray-300 text-gray-700 bg-white hover:bg-gray-50 peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600';
                        input.addEventListener('change', () => {
                            submitButton.disabled = false;
                        });
                    } else {
                        input.disabled = true;
                        labelClasses += 'border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed ';
                        if (slot.status === 'booked') {
                            labelText += ' (Booked)';
                             labelClasses += 'line-through';
                        } else if (slot.status === 'past') {
                            labelText += ' (Past)';
                             labelClasses += 'opacity-60';
                        }
                    }

                    label.className = labelClasses;
                    label.appendChild(input);
                    const textSpan = document.createElement('span');
                    textSpan.textContent = labelText;
                    label.appendChild(textSpan);

                    timeSlotContainer.appendChild(label);
                });

                if (!hasAvailableSlots) {
                    slotsMessage.textContent = 'No available slots for booking on this date.';
                    slotsMessage.className = 'text-gray-500 text-sm col-span-full';
                    slotsMessage.style.display = 'block';
                    timeSlotContainer.appendChild(slotsMessage);
                    submitButton.disabled = true;
                }

            } else {
                slotsMessage.textContent = 'No time slots defined for this day.';
                slotsMessage.className = 'text-gray-500 text-sm col-span-full';
                slotsMessage.style.display = 'block';
                timeSlotContainer.appendChild(slotsMessage);
                submitButton.disabled = true;
            }
        } catch (error) {
            loadingMessage.style.display = 'none';
            slotsMessage.textContent = `Error loading time slots: ${error.message}. Please try refreshing.`;
            slotsMessage.className = 'text-red-600 text-sm col-span-full';
            slotsMessage.style.display = 'block';
            timeSlotContainer.appendChild(slotsMessage);
            submitButton.disabled = true;
            console.error('Fetch error:', error);
        }
    }

    if (dateInput.value) {
        fetchAndDisplaySlots(dateInput.value);
    } else {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        fetchAndDisplaySlots(today);
    }

    dateInput.addEventListener('change', function() {
        fetchAndDisplaySlots(this.value);
    });

     const bookingForm = document.getElementById('booking-form');
     bookingForm.addEventListener('submit', function() {
         submitButton.disabled = true;
         submitButton.textContent = 'Processing...';
     });
});
</script>
{% endblock %}