{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-2xl flex flex-col gap-8">
    <div class="flex flex-col gap-4">
        <p class="text-3xl font-bold mb-4">Book {{ field.name }}</p>
    </div>

    {% if messages %}
        <div class="mb-6 space-y-2">
            {% for message in messages %}
                <div class="p-4 rounded-md text-sm
                    {% if message.tags == "success" %} bg-green-100 text-green-800 border border-green-200
                    {% elif message.tags == "error" %} bg-red-100 text-red-800 border border-red-200
                    {% elif message.tags == "warning" %} bg-yellow-100 text-yellow-800 border border-yellow-200
                    {% else %} bg-blue-100 text-blue-800 border border-blue-200 {% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" id="booking-form" action="{% url "bookings:show_book" field.id %}">
        {% csrf_token %}

        <div class="mb-6 bg-white p-6 rounded-lg shadow-md">
            <label for="{{ form.booking_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.booking_date.label }}</label>

            {{ form.booking_date }}
            
            {% if form.booking_date.errors %}
                {% for error in form.booking_date.errors %}
                    <p class="text-red-600 text-xs mt-1">{{ error }}</p>
                {% endfor %}
            {% endif %}
        </div>

        <div class="mb-6 bg-white p-6 rounded-lg shadow-md">
            <p class="block text-sm font-medium text-gray-700 mb-3">{{ form.time_slot.label }}</p>
            <div id="time-slot-options" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <p id="loading-slots" class="text-gray-500 text-sm col-span-full">Select a date to see available times.</p>
                <p id="slots-message" class="text-gray-500 text-sm col-span-full hidden"></p>

                {% if form.time_slot.errors %}
                    {% for error in form.time_slot.errors %}
                        <p class="text-red-600 text-xs mt-2 col-span-full">{{ error }}</p>
                    {% endfor %}
                {% endif %}

                {% if form.non_field_errors %}
                    {% for error in form.non_field_errors %}
                        <p class="text-red-600 text-xs mt-2 col-span-full">{{ error }}</p>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" id="submit-button" disabled>
            Book Now (Rp {{ field.price | floatformat:0 }})
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const dateInput = document.getElementById("id_booking_date");
        const timeSlotContainer = document.getElementById("time-slot-options");
        const loadingMessage = document.getElementById("loading-slots");
        const slotsMessage = document.getElementById("slots-message");
        const submitButton = document.getElementById("submit-button");
        const fieldId = "{{ field.id }}";

        let hasAvailableSlots = false;

        function updateSelectionStyle() {
            const allLabels = timeSlotContainer.querySelectorAll(".time-slot-label");
            
            allLabels.forEach(lbl => {
                lbl.classList.remove("selected");
            });

            const checkedRadio = timeSlotContainer.querySelector("input[name='time_slot']:checked");

            if (checkedRadio) {
                checkedRadio.closest(".time-slot-label").classList.add("selected");
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }

        async function fetchAndDisplaySlots(selectedDate) {
            timeSlotContainer.innerHTML = "";
            loadingMessage.style.display = "block";
            slotsMessage.style.display = "none";
            submitButton.disabled = true;
            hasAvailableSlots = false;
            timeSlotContainer.appendChild(loadingMessage);

            if (!selectedDate) {
                loadingMessage.textContent = "Please select a valid date.";
                return;
            }

            // get available slots via AJAX
            const url = `/bookings/get_slots/${fieldId}/?date=${selectedDate}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                loadingMessage.style.display = "none";

                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! Status: ${response.status}`);
                }

                if (data.slots && data.slots.length > 0) {
                    data.slots.forEach((slot, index) => {
                        const slotValue = `${slot.start}-${slot.end}`;
                        const inputId = `id_time_slot_${index}`;

                        const label = document.createElement("label");
                        label.htmlFor = inputId;
                        label.classList.add("time-slot-label");

                        // create screen reader only input
                        // or custom radio input
                        const input = document.createElement("input");
                        input.type = "radio";
                        input.name = "time_slot";
                        input.value = slotValue;
                        input.id = inputId;
                        input.required = true;
                        input.className = "sr-only";

                        let labelText = `${slot.start}`;
                        let labelClasses = "block w-full text-center px-4 py-3 border rounded-lg text-sm font-medium cursor-pointer transition-colors duration-200 ";

                        if (slot.status === "available") {
                            hasAvailableSlots = true;
                            labelClasses += "border-gray-300 text-gray-700 bg-white hover:bg-gray-50";
                            input.addEventListener("change", updateSelectionStyle);
                        } else {
                            input.disabled = true;
                            labelClasses += "border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed ";
                            if (slot.status === "booked") {
                                labelText += " (Booked)";
                                labelClasses += "line-through";
                            } else if (slot.status === "past") {
                                labelText += " (Past)";
                                labelClasses += "opacity-60";
                            }
                        }

                        label.className = labelClasses;
                        label.appendChild(input);
                        const textSpan = document.createElement("span");
                        textSpan.textContent = labelText;
                        label.appendChild(textSpan);

                        timeSlotContainer.appendChild(label);
                    });

                    updateSelectionStyle();

                    if (!hasAvailableSlots) {
                        slotsMessage.textContent = "No available slots for booking on this date.";
                        slotsMessage.className = "text-gray-500 text-sm col-span-full";
                        slotsMessage.style.display = "block";
                        timeSlotContainer.appendChild(slotsMessage);
                        submitButton.disabled = true;
                    }

                } else {
                    slotsMessage.textContent = "No time slots defined for this day.";
                    slotsMessage.className = "text-gray-500 text-sm col-span-full";
                    slotsMessage.style.display = "block";
                    timeSlotContainer.appendChild(slotsMessage);
                    submitButton.disabled = true;
                }
            } catch (error) {
                loadingMessage.style.display = "none";
                slotsMessage.textContent = `Error loading time slots: ${error.message}. Please try refreshing.`;
                slotsMessage.className = "text-red-600 text-sm col-span-full";
                slotsMessage.style.display = "block";
                timeSlotContainer.appendChild(slotsMessage);
                submitButton.disabled = true;
                console.error("Fetch error:", error);
            }
        }

        if (dateInput.value) {
            fetchAndDisplaySlots(dateInput.value);
        } else {
            const today = new Date().toISOString().split("T")[0];
            dateInput.value = today;
            fetchAndDisplaySlots(today);
        }

        dateInput.addEventListener("change", function() {
            fetchAndDisplaySlots(this.value);
        });

        const bookingForm = document.getElementById("booking-form");
        bookingForm.addEventListener("submit", function() {
            submitButton.disabled = true;
            submitButton.textContent = "Processing...";
        });
    });
    </script>
{% endblock scripts %}
